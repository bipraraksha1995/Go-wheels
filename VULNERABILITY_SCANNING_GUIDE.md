# üîç Dependency Vulnerability Scanning Guide

## Overview

This guide shows how to scan your GoWheels Python dependencies for known vulnerabilities using **pip-audit** and **Safety**.

---

## Tool Comparison

| Tool | Scope | Speed | Database | CI/CD | Local |
|------|-------|-------|----------|-------|-------|
| **pip-audit** | Python only | Fast | Official PyPA advisory | ‚úÖ | ‚úÖ |
| **Safety** | Python only | Fast | Safety DB | ‚úÖ | ‚úÖ |
| **Snyk** | Multi-lang | Medium | Snyk DB | ‚úÖ | ‚úÖ |
| **Trivy** | Containers | Fast | NVD + others | ‚úÖ | ‚úÖ |

**Recommended for Django:** pip-audit (official, maintained by PyPA)

---

## Installation

### Option 1: pip-audit (Recommended)
```bash
pip install pip-audit
```

### Option 2: Safety
```bash
pip install safety
```

### Option 3: Both (Best Practice)
```bash
pip install pip-audit safety
```

---

## Local Scanning Commands

### 1Ô∏è‚É£ pip-audit (Recommended)

#### Basic Scan
```bash
pip-audit
```

#### Scan with Output
```bash
# JSON output for parsing
pip-audit --format json > audit-report.json

# Verbose output
pip-audit --verbose

# Fix automatically (where possible)
pip-audit --fix
```

#### Scan Specific Package
```bash
pip-audit --desc <package-name>
```

#### Examples:
```bash
# Scan current environment
pip-audit

# Full report with details
pip-audit --verbose --format json > vulnerability-report.json

# Fix vulnerabilities automatically
pip-audit --fix

# Only report, don't fail on vulnerabilities
pip-audit --desc
```

#### Expected Output:
```
Found 0 vulnerabilities in 16 packages
Scanned 16 packages
```

---

### 2Ô∏è‚É£ Safety

#### Basic Scan
```bash
safety check
```

#### With JSON Output
```bash
safety check --json > safety-report.json
```

#### Scan Requirements File
```bash
safety check --file requirements.txt
```

#### Full Scan
```bash
safety check --full-report
```

---

### 3Ô∏è‚É£ Trivy (For Container Images)

#### Install Trivy
```bash
# Windows
choco install trivy
# macOS
brew install trivy
# Linux
wget https://github.com/aquasecurity/trivy/releases/download/v0.48.0/trivy_0.48.0_Linux-64bit.tar.gz
```

#### Scan Docker Image
```bash
trivy image gowheels:latest
trivy image --format json --output trivy-report.json gowheels:latest
```

#### Scan Dockerfile
```bash
trivy config Dockerfile
```

---

## Automated Scanning: Local Setup

### Pre-commit Hook (Run Before Each Commit)

#### 1. Install pre-commit
```bash
pip install pre-commit
```

#### 2. Create `.pre-commit-config.yaml` (See separate file)
```bash
# Already created: .pre-commit-config.yaml
```

#### 3. Install Hook
```bash
pre-commit install
```

#### 4. Test Hook
```bash
pre-commit run --all-files
```

#### How It Works:
- Runs `pip-audit` before each `git commit`
- Blocks commit if vulnerabilities found
- Can bypass: `git commit --no-verify` (not recommended)

---

## CI/CD Pipeline: GitHub Actions

### Configuration File Location
```
.github/workflows/security-scan.yml
```

### What It Does:
‚úÖ Scans dependencies on every push and pull request
‚úÖ Generates vulnerability reports
‚úÖ Blocks PR merge if vulnerabilities found
‚úÖ Posts results as GitHub issue/PR comment
‚úÖ Emails notifications on vulnerabilities

### Trigger Events:
- Push to `main`, `develop`
- Pull requests
- Scheduled daily at 2 AM UTC

---

## Interpreting Results

### pip-audit Output Examples

#### ‚úÖ No Vulnerabilities
```
Found 0 vulnerabilities in 16 packages
Scanned 16 packages
```

#### ‚ö†Ô∏è Vulnerabilities Found
```
Found 2 vulnerabilities in 16 packages

Name: django
Version: 4.2.0
ID: GHSA-xxxx-xxxx-xxxx
Fix Version: 4.2.8
Description: SQL Injection vulnerability in ORM

Name: requests
Version: 2.25.0
ID: GHSA-yyyy-yyyy-yyyy
Fix Version: 2.31.0
Description: Connection pooling issue
```

### How to Read:
- **Name**: Package with vulnerability
- **Version**: Your installed version
- **ID**: CVE/GHSA identifier
- **Fix Version**: Version with patch
- **Description**: What's broken

---

## Handling Vulnerabilities

### Step 1: Check Vulnerability Details
```bash
# Get full info
pip-audit --verbose
```

### Step 2: Update Package
```bash
# If fix is available
pip install --upgrade <package-name>

# Specific version
pip install <package-name>==<fix-version>
```

### Step 3: Update requirements.txt
```bash
pip freeze > requirements.txt
```

### Step 4: Test Application
```bash
python manage.py test
python manage.py runserver
```

### Step 5: Verify Scan
```bash
pip-audit
```

---

## Handling False Positives

If vulnerability is known but safe for your use case:

### Option 1: Add to Ignore List
Create `pyproject.toml`:
```toml
[tool.pip-audit]
ignore = [
    "GHSA-xxxx-xxxx-xxxx",  # Reason: explanation here
    "CVE-2024-xxxx",        # Reason: Not applicable to our use case
]
```

### Option 2: Ignore in CI Only
```yaml
# In GitHub Actions
- name: Audit Python Packages
  run: pip-audit --ignore GHSA-xxxx-xxxx-xxxx --ignore CVE-2024-xxxx
```

### Document Decisions
Create `VULNERABILITY_EXCEPTIONS.md`:
```markdown
## Known Vulnerabilities - Accepted Risk

### GHSA-xxxx-xxxx-xxxx
- Package: django
- Version: 4.2.0
- Risk: Low
- Reason: Not applicable to our API usage
- Accepted by: Security team
- Date: 2024-01-15
- Review Date: 2024-04-15
```

---

## Integration with Your Workflow

### 1. Local Development
```bash
# Install tools
pip install pip-audit safety pre-commit

# Install pre-commit hooks
pre-commit install

# Now vulnerabilities are checked before commit
git commit -m "your message"  # Scans first
```

### 2. Pull Requests
- GitHub Actions runs security-scan.yml
- Results posted as check on PR
- Merge blocked if vulnerabilities found

### 3. Daily Checks
- Scheduled scan at 2 AM UTC
- Reports sent to security team
- GitHub issue created if new vulnerabilities

---

## Recommended Schedule

### Development
```bash
# Before committing (automatic via pre-commit)
pre-commit run --all-files
```

### CI/CD
```yaml
# On every push/PR
- Push to main/develop
- Pull request opened
- Daily at 2 AM UTC
```

### Manual
```bash
# Weekly full scan
pip-audit --verbose > vulnerability-report-weekly.json
```

---

## Commands Quick Reference

```bash
# Installation
pip install pip-audit safety

# Local scan (pip-audit)
pip-audit                           # Basic scan
pip-audit --verbose                 # Detailed scan
pip-audit --fix                     # Auto-fix vulnerabilities
pip-audit --format json             # JSON output
pip-audit --ignore GHSA-xxxx-xxxx   # Ignore vulnerability

# Local scan (Safety)
safety check                         # Basic scan
safety check --json                 # JSON output
safety check --full-report          # Detailed report

# Pre-commit
pre-commit install                  # Install hooks
pre-commit run --all-files          # Run all hooks now

# Container scan (Trivy)
trivy image gowheels:latest         # Scan image
trivy config Dockerfile             # Scan Dockerfile
trivy image --format json gowheels  # JSON output
```

---

## Vulnerability Severity Levels

| Level | CVSS Score | Action | Timeline |
|-------|-----------|--------|----------|
| üî¥ Critical | 9.0-10.0 | Immediate patch | 24-48 hours |
| üü† High | 7.0-8.9 | Urgent patch | 1 week |
| üü° Medium | 4.0-6.9 | Plan patch | 2-4 weeks |
| üü¢ Low | 0.1-3.9 | Monitor | 30 days |

---

## Resources

- [pip-audit Documentation](https://github.com/pypa/pip-audit)
- [Safety Documentation](https://docs.safetycli.com/)
- [Trivy Documentation](https://aquasecurity.github.io/trivy/)
- [NIST CVE Database](https://nvd.nist.gov/)
- [GitHub Advisory Database](https://github.com/advisories)

---

## Next Steps

1. ‚úÖ Install pip-audit: `pip install pip-audit`
2. ‚úÖ Run initial scan: `pip-audit`
3. ‚úÖ Install pre-commit hooks: `pre-commit install`
4. ‚úÖ Set up GitHub Actions: See `.github/workflows/security-scan.yml`
5. ‚úÖ Create exception list: Create `VULNERABILITY_EXCEPTIONS.md`

---

**Status:** üîç Ready to scan your dependencies for vulnerabilities
