name: ğŸ” Dependency Vulnerability Scanning

on:
  push:
    branches: [ main, develop, master ]
    paths: [ 'requirements.txt', 'Dockerfile', '.github/workflows/security-scan.yml' ]
  pull_request:
    branches: [ main, develop, master ]
    paths: [ 'requirements.txt', 'Dockerfile' ]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  # Allow manual trigger
  workflow_dispatch:

jobs:
  pip-audit:
    name: ğŸ Python Dependency Scan (pip-audit)
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: [ '3.12', '3.13' ]
      fail-fast: false
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ” Run pip-audit
        id: pip_audit
        continue-on-error: true
        run: |
          pip install pip-audit
          pip-audit --desc --format json > pip-audit-report.json 2>&1 || true
          pip-audit --desc

      - name: ğŸ“Š Upload pip-audit Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: pip-audit-report-py${{ matrix.python-version }}
          path: pip-audit-report.json
          retention-days: 30

      - name: âš ï¸ Comment on PR
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **Vulnerability Detected**\n\nThe dependency audit found vulnerabilities. Check the Security Scan workflow for details.\n\nğŸ“„ View reports in the workflow artifacts.'
            })

  safety-check:
    name: ğŸ›¡ï¸ Python Dependency Scan (Safety)
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ğŸ“¦ Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ” Run Safety Check
        id: safety
        continue-on-error: true
        run: |
          pip install safety
          safety check --json > safety-report.json 2>&1 || true
          safety check --full-report

      - name: ğŸ“Š Upload Safety Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: safety-report
          path: safety-report.json
          retention-days: 30

  trivy-scan:
    name: ğŸ‹ Container Image Scan (Trivy)
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ—ï¸ Build Docker Image
        run: |
          docker build -t gowheels:${{ github.sha }} .
          docker tag gowheels:${{ github.sha }} gowheels:latest

      - name: ğŸ” Run Trivy Scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'gowheels:latest'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: ğŸ“Š Upload Trivy Results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'
          category: 'trivy'

  osv-scanner:
    name: ğŸ” Open Source Vulnerability (OSV)
    runs-on: ubuntu-latest
    continue-on-error: true
    
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ” Run OSV Scanner
        uses: google/osv-scanner-action@v1
        with:
          scan-args: |-
            --recursive
            --json=osv-results.json
            .

      - name: ğŸ“Š Upload OSV Results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: osv-results
          path: osv-results.json
          retention-days: 30

  sbom:
    name: ğŸ“¦ Generate SBOM (Syft)
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Install Syft
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

      - name: ğŸ“„ Generate SBOM (CycloneDX JSON)
        run: |
          # Generate CycloneDX JSON SBOM for the repository root
          syft dir:. -o cyclonedx-json=sbom.json || syft . -o cyclonedx-json=sbom.json

      - name: ğŸ“Š Upload SBOM
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: sbom
          path: sbom.json
          retention-days: 90

  report:
    name: ğŸ“‹ Generate Summary Report
    runs-on: ubuntu-latest
    needs: [ pip-audit, safety-check, trivy-scan, osv-scanner, sbom ]
    if: always()
    
    steps:
      - name: ğŸ“¥ Download All Reports
        uses: actions/download-artifact@v3

      - name: ğŸ“Š Generate Summary
        run: |
          echo "# ğŸ” Security Scan Report" > security-summary.md
          echo "" >> security-summary.md
          echo "**Date:** $(date)" >> security-summary.md
          echo "**Commit:** ${{ github.sha }}" >> security-summary.md
          echo "" >> security-summary.md
          
          echo "## Scan Results" >> security-summary.md
          echo "" >> security-summary.md
          echo "âœ… pip-audit: [Report](pip-audit-report.json)" >> security-summary.md
          echo "âœ… Safety: [Report](safety-report.json)" >> security-summary.md
          echo "âœ… Trivy: [Report](trivy-results.sarif)" >> security-summary.md
          echo "âœ… OSV: [Report](osv-results.json)" >> security-summary.md
          echo "âœ… SBOM: [SBOM](sbom.json)" >> security-summary.md
          echo "" >> security-summary.md
          
          cat security-summary.md

      - name: ğŸ“¤ Upload Summary
        uses: actions/upload-artifact@v3
        with:
          name: security-summary
          path: security-summary.md
          retention-days: 90

  notification:
    name: ğŸ”” Send Notifications
    runs-on: ubuntu-latest
    needs: [ pip-audit, safety-check ]
    if: failure()
    
    steps:
      - name: ğŸ“§ Notify Security Team
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: 'âŒ Vulnerability detected in dependencies. Check security-scan workflow for details.'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
        if: always()

      - name: ğŸ› Create GitHub Issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Security Alert: Vulnerabilities Detected',
              body: `Workflow: ${context.workflow}\nRun: ${context.runId}\n\nCheck the Security Scan workflow for details.`,
              labels: ['security', 'vulnerability']
            })
        if: failure()
